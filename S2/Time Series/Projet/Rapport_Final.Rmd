---
title: "Etude dans le temps des décès dût aux accidents de la route au Royaume-Uni"
subtitle: "Master 1 MAS Rennes - Série Temporelle"
author: "BERNARD Baptiste, MONFRET Dylan, RAKOTOSON Loïc"
geometry: margin=2.5cm
lang: "fr-FR"
documentclass: article
classoption: a4paper
urlcolor: "blue"
fontsize: "11pt"
date: "Pour le 15 mai 2020"
output:
  html_notebook:
    df_print: paged
    highlight: tango
    theme: cerulean
    number_sections: true
jupyter:
  jupytext:
    formats: ipynb,Rmd
    text_representation:
      extension: .Rmd
      format_name: rmarkdown
      format_version: '1.1'
      jupytext_version: 1.2.4
  kernelspec:
    display_name: R
    language: R
    name: ir
---

\pagenumbering{gobble}
\newpage
\pagenumbering{arabic} 

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r include=FALSE}
library(forecast)
library(ggfortify)
library(tidyverse)
```

# Contextualisation & Méthodologie

Les données sont les enregistrements mensuels du nombre de morts, `death`, sur les accidents de la route au Royaume-Uni entre Janvier 1969 et Décembre 1984. La loi sur le port obligatoire de la ceinture de sécurité, `law`, a été introduite en Février 1983. La variable `law` prend alors la valeur 0 pour les mois où la loi n'est pas en vigueur, 1 lorsqu'elle est en vigueur.

L'objectif de cette étude sera de proposer diverses modélisations de la série temporelle, qui permettraient par exemple de "simuler" le nombre de décès sur les routes britanniques arpès 1984.

```{r}
period <-
  seq(as.Date('1969-01-01'), as.Date('1984-12-31'), by = "month")

ukdeath <- 
  read_delim("data.txt", delim = "  ", col_types = "if") %>%
  mutate(death_log = log(death),
         period = period)
```

```{r echo=FALSE}
summary(ukdeath)
head(ukdeath, 10)
```

```{r echo=FALSE, message=FALSE, warning=FALSE}
ggplot(ukdeath) +
  aes(x = period, y = death, color = law) +
  geom_point() + geom_line() + stat_smooth(method = "loess") +
  labs(title = "Nombre de décès lors d'accidents de la route au Royaume-Uni") +
  theme(plot.title = element_text(hjust = 0.5))
```

Une première observation de la série, avec mise en évidence des périodes d'application de la loi sur le port de la ceinture, permet de visualiser deux éléments constitutifs de la série :

* Le premier étant la périodicité du nombre de mort sur les routes, avec des accroissements significatifs à chaque fin d'année.
* Le second étant la tendance générale de la série, bien mis en relief par la [régression locale (méthode non paramétrique, *LOESS*)](https://fr.wikipedia.org/wiki/R%C3%A9gression_locale). Le nombre de décès chaque année à tendance à __s'accroitre entre 1969 et 1973__, à __décroitre entre 1973 et 1976__, à __stagner de 1976 à 1983__, avant de __chuter brutalement avec la mise en application de la loi sur le port de la ceinture en Février 1983__.

Intuitivement, nous pourrions construire nos modèles autour d'une saisonalité des décès sur les routes par rapport fin d'année (période des fêtes), soit __un pique de décès tous les 12 mois__ ; et  en prenant en compte 2 à 3 phases de la série temporelle (2 phases si l'on se ramène uniquements à la période sans la loi et la période avec application de celle-ci).

C'est point de rupture sont aussi visualisable avec le package **`changepoint`** et sa fonction `cpt.meanvar`, et cela sans prendre en compte la variable `law`.

```{r echo=FALSE, message=FALSE, warning=FALSE}
ts_ukdeath <-
  ts(data = ukdeath$death,
     start = c(1969, 1),
     frequency = 12)

ts_ukdeath %>%
  changepoint::cpt.meanvar(method = "PELT", minseglen = 11)  %>%
  autoplot() +
  labs(title = "Points de rupture", x = "period", y = "death") +
  theme(plot.title = element_text(hjust = 0.5))
```

Pour la suite de l'étude, nous travaillerons avec le nombre de décès passé au $\log$. Une variabilté réduite peut nous garantir un meilleur ajustement en concervant la forme de la série.

```{r}
var(ukdeath$death)
var(ukdeath$death_log)
```


```{r,fig.width=8, message=FALSE, warning=FALSE}
ggplot(ukdeath) +
  aes(x = period, y = death_log, color = law) +
  geom_point() + geom_line() + stat_smooth(method = "loess") +
  labs(title = "Nombre de décès passé au log") +
  theme(plot.title = element_text(hjust = 0.5))

ts_ukdeath_log <-
  ts(
    data = ukdeath$death_log,
    start = c(1969, 1),
    frequency = 12
  )

ts_ukdeath_log %>%
  changepoint::cpt.meanvar(method = "PELT", minseglen = 11)  %>%
  autoplot() +
  labs(title = "Points de rupture (log)", x = "period", y = "death_log") +
  theme(plot.title = element_text(hjust = 0.5))
```

# Visualiser et confirmer la saisonalité

Pour construire les modèles adéquats à notre problème, nous devons avoir une idée précise des caractéristiques de la série. Il s'agit ici de confirmer si la saisonalité des décès est bien de 12 mois, et de l'autocorrélation des données (lien ou similitude entre l'été 1963 et l'été 1973, par exemple).

## *Lag Plot*, *Month Plot* et autocorrélations de la série

Les représentations graphiques de la variable d'intérêt par rapport au temps sont de bons indicateurs pour émettre des hypothèses quant à la saisonalité d'une série temporelle.

* Le **Lag Plot**, mettant en perspective la valeur d'une variable à un instant $t$ et à un instant $t-h$ permet de visualiser le lien linéaire entre deux instants et l'on peut répondre au question du type : *"Est-ce qu'un même schéma se répète à 6 mois / 2 ans / 10 secondes d'intervalles" ? Cela se traduit par le plus ou moins bon alignement des points sur la première bissectrice.

* Le **Month Plot** décompose la série par mois. C'est asssez utile lorsque les données sont renseignés mensuellement, on peut alors l'évolution de la variable par mois et au cours des années, avec par défaut l'indication de la valeur moyenne pour chaque mois. On peut alors constater les mois clés de la saisonalité d'une série.

* Les graphiques de représentation de l'autocorrélation et de l'autocorrélation partielle, respectivement **ACF** et **PACF**, mettent eux en évidence le lien entre une valeur prise à un instant $t$ et celui à un instant $t-h$. L'autocorrélation partielle prend en compte en plus de cela le temps écoulé, en incluant les décalages précédents, donc les valeurs à $t-h-k, \space k<h$.

Et donc, en ce qui nous concerne, le `lag.plot` mais bien en évidence le lien linéaire entre le nombre de décès à un mois $t$ et le nombre de décès à $t-12$ mois (et légèrement à $t-1$, mais probablement puisque les comportements individuelles ne change pas radicalement d'un mois sur l'autre).

```{r, fig.width=8, message=FALSE, warning=FALSE}
lag.plot(ukdeath$death_log, lags = 16)
```

C'est une information confirmé également par l'ACF. L'autocorrélation fini par s'annuler plus significativement qu'une passer le décalage seuil de environ 150 mois, correspondant à l'entrée en vigueur de la loi sur le port de la ceinture, et l'effondrement du nombre de décès.

Le PACF montre également des signes de la saisonalité, mais avec pour nuance supplémentaire que l'ensemble des valeurs prises précédement par la série n'influe pas les valeurs futures. Les valeurs approchant 0 après un décalage seuil de 25 mois.

```{r, fig.width=8, message=FALSE, warning=FALSE}
ggAcf(ts_ukdeath_log, 72)
ggAcf(ts_ukdeath_log, 191)
ggPacf(ts_ukdeath_log, lag.max = 72)
```

Enfin le Month Plot fini de démontrer la tendance des décès par mois :

* En année : une diminution brutale du nombre de décès vers les dernières années de mesure du nombre de décès.
* En mois : un accroissement du nombre de décès pendant l'hiver et les fêtes de fin d'année (de octobre à janvier) et une période plus calme avec les beaux jours (de mars à août). 

```{r, fig.width=8, message=FALSE, warning=FALSE}
ggmonthplot(ts_ukdeath_log) +
  labs(title = "Month Plot des décès (log)", x = "Mois", y = "death_log")
```

## Opérateurs de différence pour le modèle additif

Pour construire un modèle additif, il est nécessaire de connaître la saisonalité de notre série, mais aussi le degré du polynômes composant le modèle. La série $x_t$ peut donc s'écrire sous cette forme :

$$x_t=m_t+s_t+u_t$$

* $m_t$ est associé au polynôme du temps (par exemple : $t + t^2 + t^3$)
* $s_t$ est associé à la fonction de saisonalité, captant le phénomène oscillatoire (dont la définition sera notée ci-après).
* $u_t$ est une suite de résidus indépendants, sans structure, réalisations de variables aléatoires indépendantes.

Les résidus ne peuvent être obtenu, mais les deux termes composants $x_t$ peuvent s'obtenir en observant les variations de **l'opérateur différence** $\Delta$. Un opérateur dont on peut faire varier le décalage (ou *lag*) $h$.

$$\Delta^hx_t = \sum_{j=0}^{h}\binom{h}{j}x_{t-j}$$

Dans l'idéal, on souhaite trouver le décalage $h$ tel que $\Delta$ s'annule. Pour trouver le degré du polynôme, nous pouvons aussi passer cette opérateur à la puissance $q$ et choisir la puissance tel que $\Delta$ soit nul. Nous pouvons évaluer cela avec la fonction `diff` et ses arguments `lag` & `differencies`, correspondant respectivement à $h$ et $q$. NoS objectifs seront donc de :

* Trouver le décalage $h$ minimale de la série telle que l'opérateur de différence s'annule en limitant la variabilité de cette suite généré.
* Trouver la puissance $q$ optimale du polynôme $m_t$ en limitant également la variabilité des termes de $\Delta$.

### La saisonalité ($h$ / `lag`)

Dans un premier temps, c'est le paramètre $h$ / `lag` que nous allons faire varier, entre 1 et 191 (puisque la série est composé de 192).  mesure).

```{r, fig.width=8, message=FALSE, warning=FALSE}
Lag_Mean <- NULL
Lag_Var <- NULL

for (ind in 1:191) {
  diff <- diff(ukdeath$death_log, ind, 1)
  Lag_Mean[ind] <- mean(diff)
  Lag_Var[ind] <- var(diff)
}

PLag_Mean <-
  ggplot() +
  aes(y = Lag_Mean, x = 1:191) +
  geom_point()

PLag_Var <- 
  ggplot() +
  aes(y = Lag_Var, x = 1:191) +
  geom_point()

PLag_Mean + labs(title = "Month Plot des décès (log)", x = "Mois", y = "death_log")
PLag_Var + labs(title = "Month Plot des décès (log)", x = "Mois", y = "death_log")
```

### Le degré (`differencies`)

```{r, fig.width=8, message=FALSE, warning=FALSE}
Dif_Mean <- NULL
Dif_Var <- NULL

for (ind in 1:36) {
  diff <- diff(ukdeath$death_log, 1, ind)
  Dif_Mean[ind] <- abs(mean(diff))
  Dif_Var[ind] <- var(diff)
}

ggplot() + aes(y = Dif_Mean, x = 1:36) + geom_point()
ggplot() + aes(y = Dif_Var, x = 1:36) + geom_point()
```

### Constatation avec les arguments optimaux

lag : 12
diff : 1 ou 2

```{r, fig.width=8, message=FALSE, warning=FALSE}
exemple <- diff(ukdeath$death_log, 12 , 2)
acf(exemple, 191)
pacf(exemple, 191)
```

# Modélisations

## Modèle additif

```{r}
t <- 1:192
sinusoides <- t %o% c(rep(1:5, 2)) * pi / 6
sinusoides[, 1:5] <- sin(sinusoides[, 1:5])
sinusoides[, 6:10] <- cos(sinusoides[, 6:10])
sinusoides <- as.data.frame(sinusoides)
names(sinusoides) <-
  c(paste("sin_", 1:5, sep = ""), paste("cos_", 1:5, sep = ""))
```

```{r}
death_log <- ukdeath$death_log
ModAdd_df <- data.frame(death_log, t, t ^ 2, t ^ 3)
ModAdd_df <- cbind(ModAdd_df, sinusoides)
ModAdd_lm <- lm(data = df, log_death ~ .)
summary(ModAdd_lm)
```

```{r, fig.width=8, message=FALSE, warning=FALSE}
plot(ModAdd_lm)
plot(ModAdd_lm$residuals)
t.test(ModAdd_lm$residuals)
acf(ModAdd_lm$residuals, 192)
```


```{r, fig.width=8, message=FALSE, warning=FALSE}
MA <- arima(log_death, c(1, 2, 1))
plot(MA$residuals)
```

